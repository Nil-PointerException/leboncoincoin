quarkus:
  application:
    name: leboncoincoin-backend

  # Lambda HTTP configuration
  lambda:
    handler: stream

  # RESTEasy Reactive
  resteasy-reactive:
    path: /api

  # OIDC / Clerk Authentication
  oidc:
    enabled: ${OIDC_ENABLED:false}
    auth-server-url: ${CLERK_AUTH_SERVER_URL:}
    client-id: ${CLERK_CLIENT_ID:}
    credentials:
      secret: ${CLERK_CLIENT_SECRET:}
    tls:
      verification: ${OIDC_TLS_VERIFICATION:required}
    token:
      issuer: ${CLERK_ISSUER:}
      audience: ${CLERK_AUDIENCE:}
    authentication:
      cookie-path: /
      redirect-path: /login
      scopes: openid,email,profile

  # Database (PostgreSQL)
  datasource:
    db-kind: postgresql
    username: ${DB_USERNAME:leboncoincoin_user}
    password: ${DB_PASSWORD:leboncoincoin_password}
    jdbc:
      url: ${DB_URL:jdbc:postgresql://localhost:5432/leboncoincoin_db}
      max-size: 16

  # Hibernate ORM
  hibernate-orm:
    database:
      generation: none
    log:
      sql: ${DB_LOG_SQL:false}

  # Flyway migrations
  flyway:
    migrate-at-start: true
    baseline-on-migrate: true
    baseline-version: 1.0.0

  # S3
  s3:
    endpoint-override: ${S3_ENDPOINT:}
    aws:
      region: ${AWS_REGION:eu-west-3}
      credentials:
        type: default
    # Enable path-style access for MinIO compatibility
    path-style-access: ${S3_PATH_STYLE:false}

  # SES (for production email sending)
  ses:
    aws:
      region: ${AWS_REGION:eu-west-3}
      credentials:
        type: default

  # Mailer (SMTP for development)
  mailer:
    from: ${EMAIL_FROM:noreply@leboncoincoin.com}
    host: ${SMTP_HOST:localhost}
    port: ${SMTP_PORT:1025}
    username: ${SMTP_USERNAME:}
    password: ${SMTP_PASSWORD:}
    start-tls: ${SMTP_START_TLS:DISABLED}
    auth-methods: ${SMTP_AUTH_METHODS:}

  # HTTP
  http:
    port: 8080
    cors:
      ~: true
      origins: ${CORS_ORIGINS:http://localhost:5173}
      methods: GET,POST,PUT,DELETE,OPTIONS
      headers: accept,authorization,content-type,x-requested-with
      exposed-headers: Content-Disposition
      access-control-max-age: 86400

  # Logging
  log:
    level: INFO
    category:
      "com.leboncoincoin":
        level: DEBUG
    console:
      enable: true
      format: "%d{HH:mm:ss} %-5p [%c{2.}] (%t) %s%e%n"

# Application-specific configuration
app:
  s3:
    bucket-name: ${S3_BUCKET_NAME:leboncoincoin-images}
    presigned-url-expiration: 300 # 5 minutes in seconds
  email:
    provider: ${EMAIL_PROVIDER:smtp} # "smtp" for dev (MailHog), "ses" for prod
    from: ${EMAIL_FROM:noreply@leboncoincoin.com}
    from-name: ${EMAIL_FROM_NAME:LeBonCoinCoin}
    welcome-enabled: ${EMAIL_WELCOME_ENABLED:true}
  messaging:
    allow-self-messaging: ${ALLOW_SELF_MESSAGING:false}

# Development profile (local testing with MinIO and test auth)
"%dev":
  quarkus:
    # Disable OIDC authentication in dev mode
    oidc:
      enabled: false
    
    # Security configuration for dev mode
    security:
      # Allow security annotations to work without real auth
      auth:
        enabled-in-dev-mode: true
      # Use custom dev authentication mechanism
      users:
        embedded:
          enabled: false
    
    # Use local MinIO as S3
    s3:
      endpoint-override: http://localhost:9000
      aws:
        region: us-east-1
        credentials:
          type: static
          static-provider:
            access-key-id: minioadmin
            secret-access-key: minioadmin
    
    # Enable SQL logging for debugging
    hibernate-orm:
      log:
        sql: true
    
    # Verbose logging for dev
    log:
      level: DEBUG
      category:
        "com.leboncoincoin":
          level: DEBUG
        "io.quarkus.oidc":
          level: DEBUG
    
    # CORS for local frontend
    http:
      cors:
        origins: http://localhost:5173,http://localhost:3000
  
  # Dev-specific app configuration
  app:
    s3:
      bucket-name: leboncoincoin-images
      presigned-url-expiration: 3600 # 1 hour for easier testing
    email:
      provider: smtp # Use MailHog in dev
      from: dev@leboncoincoin.local
      from-name: LeBonCoinCoin (Dev)
    dev:
      auth-enabled: false
      test-user-id: dev-user-123
      test-user-email: dev@leboncoincoin.local
      test-user-name: Dev User

# Clerk profile (for local development with Clerk authentication)
"%clerk":
  quarkus:
    # Enable OIDC authentication with Clerk
    oidc:
      enabled: true
      auth-server-url: ${CLERK_AUTH_SERVER_URL:https://YOUR_DOMAIN.clerk.accounts.dev}
      client-id: ${CLERK_CLIENT_ID:YOUR_DOMAIN}
      token:
        issuer: ${CLERK_ISSUER:https://YOUR_DOMAIN.clerk.accounts.dev}
        audience: ${CLERK_AUDIENCE:}
      tls:
        verification: none  # Use 'none' for local dev, 'required' for production
    
    # Use local MinIO as S3
    s3:
      endpoint-override: http://localhost:9000
      path-style-access: true
      aws:
        region: us-east-1
        credentials:
          type: static
          static-provider:
            access-key-id: minioadmin
            secret-access-key: minioadmin
    
    # Enable SQL logging for debugging
    hibernate-orm:
      log:
        sql: true
    
    # Verbose logging
    log:
      level: DEBUG
      category:
        "com.leboncoincoin":
          level: DEBUG
        "io.quarkus.oidc":
          level: DEBUG
        "io.quarkus.security":
          level: DEBUG
    
    # CORS for local frontend
    http:
      cors:
        origins: http://localhost:5173,http://localhost:3000
  
  # Clerk profile app configuration
  app:
    s3:
      bucket-name: leboncoincoin-images
      presigned-url-expiration: 3600
    email:
      provider: smtp # Use MailHog in clerk profile too
      from: dev@leboncoincoin.local
      from-name: LeBonCoinCoin (Clerk Dev)
    dev:
      auth-enabled: true  # Disable dev auth, use real OIDC
      test-user-id: ""

# Test profile (for unit/integration tests)
"%test":
  quarkus:
    # Disable OIDC authentication in test mode
    oidc:
      enabled: false
    
    # Security configuration for test mode
    security:
      # Allow security annotations to work without real auth
      auth:
        enabled-in-dev-mode: true
      # Use custom dev authentication mechanism
      users:
        embedded:
          enabled: false
    
    # Use in-memory H2 or local PostgreSQL for tests
    datasource:
      db-kind: postgresql
      username: ${DB_USERNAME:leboncoincoin_user}
      password: ${DB_PASSWORD:leboncoincoin_password}
      jdbc:
        url: ${DB_URL:jdbc:postgresql://localhost:5432/leboncoincoin_db}
    
    # Hibernate configuration for tests
    hibernate-orm:
      database:
        generation: drop-and-create
      log:
        sql: true
    
    # Flyway - skip for tests (we use drop-and-create)
    flyway:
      migrate-at-start: false
    
    # Use local MinIO for tests
    s3:
      endpoint-override: http://localhost:9000
      path-style-access: true
      aws:
        region: us-east-1
        credentials:
          type: static
          static-provider:
            access-key-id: minioadmin
            secret-access-key: minioadmin
    
    # Test logging
    log:
      level: INFO
      category:
        "com.leboncoincoin":
          level: DEBUG
  
  # Test-specific app configuration
  app:
    s3:
      bucket-name: leboncoincoin-images
      presigned-url-expiration: 300
    email:
      provider: smtp # Use mock SMTP in tests
      from: test@leboncoincoin.local
      from-name: LeBonCoinCoin (Test)
      welcome-enabled: false # Disable welcome emails in tests
    messaging:
      allow-self-messaging: true # Allow same user to be buyer and seller in tests
    dev:
      auth-enabled: false
      test-user-id: test-user-123
      test-user-email: test@leboncoincoin.local
      test-user-name: Test User

# Production profile (for AWS Lambda + RDS)
"%prod":
  quarkus:
    datasource:
      jdbc:
        url: ${DB_URL}
      username: ${DB_USERNAME}
      password: ${DB_PASSWORD}
    hibernate-orm:
      database:
        generation: none
      log:
        sql: false
    log:
      level: INFO
      category:
        "com.leboncoincoin":
          level: INFO

