quarkus:
  application:
    name: leboncoincoin-backend

  # Lambda HTTP configuration
  lambda:
    handler: stream

  # RESTEasy Reactive
  resteasy-reactive:
    path: /api

  # OIDC / Clerk Authentication
  oidc:
    enabled: ${OIDC_ENABLED:false}
    auth-server-url: ${CLERK_AUTH_SERVER_URL:}
    client-id: ${CLERK_CLIENT_ID:}
    credentials:
      secret: ${CLERK_CLIENT_SECRET:}
    tls:
      verification: ${OIDC_TLS_VERIFICATION:required}
    token:
      issuer: ${CLERK_ISSUER:}
      audience: ${CLERK_AUDIENCE:}
    authentication:
      cookie-path: /
      redirect-path: /login
      scopes: openid,email,profile

  # Database (PostgreSQL) - Configuration par défaut
  datasource:
    db-kind: postgresql
    username: ${DB_USERNAME:leboncoincoin_user}
    password: ${DB_PASSWORD:leboncoincoin_password}
    jdbc:
      url: ${DB_URL:jdbc:postgresql://localhost:5432/leboncoincoin_db}
      max-size: 16

  # Hibernate ORM
  hibernate-orm:
    database:
      generation: none
    log:
      sql: ${DB_LOG_SQL:false}

  # Flyway migrations
  flyway:
    migrate-at-start: true
    baseline-on-migrate: true
    baseline-version: 1.0.0

  # S3
  s3:
    endpoint-override: ${S3_ENDPOINT:}
    aws:
      region: ${AWS_REGION:eu-west-3}
      credentials:
        type: default
    path-style-access: ${S3_PATH_STYLE:false}

  # SES
  ses:
    aws:
      region: ${AWS_REGION:eu-west-3}
      credentials:
        type: default

  # Mailer
  mailer:
    from: ${EMAIL_FROM:noreply@leboncoincoin.com}
    host: ${SMTP_HOST:localhost}
    port: ${SMTP_PORT:1025}
    username: ${SMTP_USERNAME:}
    password: ${SMTP_PASSWORD:}
    start-tls: ${SMTP_START_TLS:DISABLED}
    auth-methods: ${SMTP_AUTH_METHODS:}

  # HTTP
  http:
    port: 8080
    cors:
      ~: true
      origins: ${CORS_ORIGINS:http://localhost:5173}
      methods: GET,POST,PUT,DELETE,OPTIONS
      headers: accept,authorization,content-type,x-requested-with
      exposed-headers: Content-Disposition
      access-control-max-age: 86400

  # Logging
  log:
    level: INFO
    category:
      "com.leboncoincoin":
        level: DEBUG
    console:
      enable: true
      format: "%d{HH:mm:ss} %-5p [%c{2.}] (%t) %s%e%n"

# Application-specific configuration
app:
  s3:
    bucket-name: ${S3_BUCKET_NAME}
    presigned-url-expiration: 300
  email:
    provider: ${EMAIL_PROVIDER:smtp}
    from: ${EMAIL_FROM:noreply@leboncoincoin.com}
    from-name: ${EMAIL_FROM_NAME:LeBonCoinCoin}
    welcome-enabled: ${EMAIL_WELCOME_ENABLED:true}
  messaging:
    allow-self-messaging: ${ALLOW_SELF_MESSAGING:false}

# --- PROFILES ---

# Development profile
"%dev":
  quarkus:
    oidc:
      enabled: false
    security:
      auth:
        enabled-in-dev-mode: true
      users:
        embedded:
          enabled: false
    s3:
      endpoint-override: http://localhost:9000
      aws:
        region: us-east-1
        credentials:
          type: static
          static-provider:
            access-key-id: minioadmin
            secret-access-key: minioadmin
    hibernate-orm:
      log:
        sql: true
    log:
      level: DEBUG
      category:
        "com.leboncoincoin":
          level: DEBUG
        "io.quarkus.oidc":
          level: DEBUG
    http:
      cors:
        origins: http://localhost:5173,http://localhost:3000
  app:
    s3:
      bucket-name: leboncoincoin-bucket
      presigned-url-expiration: 3600
    email:
      provider: smtp
      from: dev@leboncoincoin.local
      from-name: LeBonCoinCoin (Dev)
    dev:
      auth-enabled: false
      test-user-id: dev-user-123
      test-user-email: dev@leboncoincoin.local
      test-user-name: Dev User

# Clerk profile
"%clerk":
  quarkus:
    oidc:
      enabled: true
      auth-server-url: ${CLERK_AUTH_SERVER_URL:https://YOUR_DOMAIN.clerk.accounts.dev}
      client-id: ${CLERK_CLIENT_ID:YOUR_DOMAIN}
      token:
        issuer: ${CLERK_ISSUER:https://YOUR_DOMAIN.clerk.accounts.dev}
        audience: ${CLERK_AUDIENCE:}
      tls:
        verification: none
    s3:
      endpoint-override: http://localhost:9000
      path-style-access: true
      aws:
        region: us-east-1
        credentials:
          type: static
          static-provider:
            access-key-id: minioadmin
            secret-access-key: minioadmin
    hibernate-orm:
      log:
        sql: true
    log:
      level: DEBUG
      category:
        "com.leboncoincoin":
          level: DEBUG
        "io.quarkus.oidc":
          level: DEBUG
        "io.quarkus.security":
          level: DEBUG
    http:
      cors:
        origins: http://localhost:5173,http://localhost:3000
  app:
    s3:
      bucket-name: leboncoincoin-bucket
      presigned-url-expiration: 3600
    email:
      provider: smtp
      from: dev@leboncoincoin.local
      from-name: LeBonCoinCoin (Clerk Dev)
    dev:
      auth-enabled: true
      test-user-id: ""

# Test profile
"%test":
  quarkus:
    oidc:
      enabled: false
    security:
      auth:
        enabled-in-dev-mode: true
      users:
        embedded:
          enabled: false
    datasource:
      db-kind: postgresql
      username: ${DB_USERNAME:leboncoincoin_user}
      password: ${DB_PASSWORD:leboncoincoin_password}
      jdbc:
        url: ${DB_URL:jdbc:postgresql://localhost:5432/leboncoincoin_db}
    hibernate-orm:
      database:
        generation: drop-and-create
      log:
        sql: true
    flyway:
      migrate-at-start: false
    s3:
      endpoint-override: http://localhost:9000
      path-style-access: true
      aws:
        region: us-east-1
        credentials:
          type: static
          static-provider:
            access-key-id: minioadmin
            secret-access-key: minioadmin
    log:
      level: INFO
      category:
        "com.leboncoincoin":
          level: DEBUG
  app:
    s3:
      bucket-name: leboncoincoin-bucket
      presigned-url-expiration: 300
    email:
      provider: smtp
      from: test@leboncoincoin.local
      from-name: LeBonCoinCoin (Test)
      welcome-enabled: false
    messaging:
      allow-self-messaging: true
    dev:
      auth-enabled: false
      test-user-id: test-user-123
      test-user-email: test@leboncoincoin.local
      test-user-name: Test User

"%prod":
  quarkus:
    # 1. Base de données : Configuration robuste pour Lambda SnapStart
    datasource:
      jdbc:
        url: ${DB_URL}
        # On utilise les variables d'env définies dans template.yaml
        initial-size: ${QUARKUS_DATASOURCE_JDBC_INITIAL_SIZE:0}
        min-size: ${QUARKUS_DATASOURCE_JDBC_MIN_SIZE:0}
        max-size: ${QUARKUS_DATASOURCE_JDBC_MAX_SIZE:2}

        # CRITIQUE : Tester la connexion avant utilisation (évite les erreurs 500)
        test-on-borrow: true
        validation-query-sql: "SELECT 1"

        # Nettoyage agressif des connexions inactives
        background-validation-interval: PT1M
        idle-removal-interval: PT1M
        max-lifetime: PT10M
      username: ${DB_USERNAME}
      password: ${DB_PASSWORD}

    # 2. Migration : Désactivée au démarrage (gérée manuellement ou via pipeline)
    flyway:
      migrate-at-start: false

    # 3. CORS : Désactivé (C'est API Gateway qui gère ça, sinon conflit !)
    http:
      cors:
        enabled: false

    hibernate-orm:
      database:
        generation: none
      log:
        sql: false

    # Logging optimisé pour CloudWatch
    log:
      level: INFO
      category:
        "com.leboncoincoin":
          level: INFO
        "org.hibernate":
          level: WARN
        "io.quarkus":
          level: INFO
      console:
        enable: true
        # Format JSON ou simple pour CloudWatch
        format: "%d{yyyy-MM-dd HH:mm:ss,SSS} %-5p [%c{2.}] (%t) %s%e%n"

    # OIDC activé
    oidc:
      enabled: ${OIDC_ENABLED:true}
      tls:
        verification: ${OIDC_TLS_VERIFICATION:required}

  # App Config Prod
  app:
    email:
      provider: ${EMAIL_PROVIDER:ses}
      from: ${EMAIL_FROM:noreply@leboncoincoin.com}
      from-name: ${EMAIL_FROM_NAME:LeBonCoinCoin}
      welcome-enabled: ${EMAIL_WELCOME_ENABLED:true}
    s3:
      bucket-name: ${S3_BUCKET_NAME}
      presigned-url-expiration: 300